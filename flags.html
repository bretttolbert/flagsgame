<!DOCTYPE html>
<html>
<head>
<title>Flags</title>
<meta charset="UTF-8">
<link rel="stylesheet" type="text/css" href="flags.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="flags.js"></script>
<script>

function getFlagImgHtml(countryIdx) {
    html = '';
    let country = getCountryByIdx(countryIdx);
    const whitespace = / /gi;
    let nameEscaped = country.name.replace(whitespace, "%20");
    html += `<a href="flagviewer.html?name=${nameEscaped}">`;
    html += `<img class="flag-image" id="${countryIdx}" src="${country.filename}" border="0" />`;
    html += `</a>`;
    return html;
}

function componentToHex(c) {
  var hex = c.toString(16);
  return hex.length == 1 ? "0" + hex : hex;
}

function rgbToHex(r, g, b) {
  return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
}

function getColorSwatchesHtml(key, clusterCountryFeatures) {
    html = '<tr>';
    html += `<div class="inner-swatches">`; //innner-swatches
    html += "<td>";
    html += `<div style="float: none">${key}</div>`
    html += "</td>";
    html += "<td>";
    try {
        let fillsRgb = clusterCountryFeatures[key];
        for (let j=0; j<fillsRgb.length; ++j) {
            let fillRgb = fillsRgb[j];
            let fill = `rgb(${fillRgb[0]}, ${fillRgb[1]}, ${fillRgb[2]})`
            let hexCode = rgbToHex(fillRgb[0], fillRgb[1], fillRgb[2]);
            html += `<div class="color-swatch" style="background-color: ${fill}; width: 64px; height: 64px">
                <div class="color-swatch-label">${hexCode}</div>
            </div>`
        }
        html += "</td>";
        html += "</div>"; // end inner-swatches
        html += "</tr>"
    } catch (ex) {
        console.error(ex);
    }
    return html;
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function getRequestParams() {
    const searchParams = new URLSearchParams(location.search);
    var requestParams = {};
    const scalarKeys = ["lang"]; //all others are list keys
    for (const key of searchParams.keys()) {
        console.log("searchParam key=" + key);
        if (scalarKeys.includes(key)) {
            const value = searchParams.get(key);
            console.log("searchParams: (scalar) " + key + " = " + value);
            requestParams[key] = value;
        } else {
            const values = searchParams.getAll(key);
            console.log("searchParams: (list) " + key + " = " + values);
            requestParams[key] = values;
        }
    }
    return requestParams
}

async function displayFlags() {
    let lang = "*";
    let tags = [];
    const requestParams = getRequestParams();
    if ("lang" in requestParams) {
        lang = requestParams["lang"];
    }
    if ("tags" in requestParams) {
        tags = requestParams["tags"];
    }
    let countryIdxs = getCountryIdxsFiltered(lang, tags);
    while (Object.entries(countryIdxs).length == 0) {
        await sleep(10);
        countryIdxs = getCountryIdxsFiltered(lang, tags);
    }
    let viewName = `Filters: lang=${lang}, tags=[${tags.join(',')}]`;
    let html = '';
    html += '<div class="cluster">';
    html += `<h1>${viewName} (count=${countryIdxs.length})</h1>`;
    // flags images
    html += '<div class="flag-images">'
    for (let i=0; i<countryIdxs.length; ++i) {
        let countryIdx = countryIdxs[i];
        html += getFlagImgHtml(countryIdx);
    }
    html += "</div>"; // end flag-images
    // color swatches
    html += '<div class="color-swatches">'
    for (let i=0; i<countryIdxs.length; ++i) {
        let countryIdx = countryIdxs[i];
        let country = getCountryByIdx(countryIdx);
        let countryFeatures = getFeaturesByCountryName(country.name);
        if (countryFeatures === undefined) {
            console.error(`getFeaturesByCountryName(${country.name}) returned undefined`);
        } else {
            html += '<div class="color-swatch-container">'
            html += "<div>" + country.name + "</div>";
            html += "<div>";
            html += getFlagImgHtml(countryIdx);
            html += "</div>";

            html += '<div class="hcentered">';
            html += "<table>";
            html += getColorSwatchesHtml("fills_rgb", countryFeatures)
            html += getColorSwatchesHtml("fills_rgb_low", countryFeatures)
            html += "</table>";
            html += "</div>";

            html += "</div>"; // end color-swatch-container
        }
    }
    html += "</div>"; // end color-swatches
    html += "</div>"; // end cluster
    $('#flagsContainer').html(html);
}

$(document).ajaxStop(function() {
    // This function runs when the number of active AJAX requests becomes zero.
    console.log("All jQuery AJAX requests have completed.");
    displayFlags();
    // You might unbind the event if it only needs to run once
    //$(this).off('ajaxStop');
});

</script>
<meta name="viewport" content="width=720, initial-scale=0.5, user-scalable=no">
</head>
<body>
<header>
    <a href="index.html">Flags Main Menu</a>
</header>
<main>
<div id="flagsContainer">
    Test
</div>
</main>
<footer>
    <a href="index.html">Flags Main Menu</a>
</footer>
</body>
</html>
