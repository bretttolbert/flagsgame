<html>
<head>
<script>


function getFlagImgHtml(cluster, countryIdx) {
    html = '';
    let country = getCountryByIdx(countryIdx);
    const whitespace = / /gi;
    let countryNameWikiEscaped = country.name.replace(whitespace, "_");
    const parenthetical_suffix = /_\(.*\)$/gi;
    countryNameWikiEscaped = countryNameWikiEscaped.replace(parenthetical_suffix, "");
    html += `<a href="https://${country.lang}.wikipedia.org/wiki/${countryNameWikiEscaped}">`;
    html += `<img class="flag-image" id="${cluster}-${countryIdx}" src="${country.filename}" border="0" />`;
    html += `</a>`;
    return html;
}

function componentToHex(c) {
  var hex = c.toString(16);
  return hex.length == 1 ? "0" + hex : hex;
}

function rgbToHex(r, g, b) {
  return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
}

function getColorSwatchesHtml(key, clusterCountryFeatures) {
    html = '<tr>';
    html += `<div class="inner-swatches">`; //innner-swatches
    html += "<td>";
    html += `<div style="float: none">${key}</div>`
    html += "</td>";
    html += "<td>";
    let fillsRgb = clusterCountryFeatures[key];
    for (let j=0; j<fillsRgb.length; ++j) {
        let fillRgb = fillsRgb[j];
        let fill = `rgb(${fillRgb[0]}, ${fillRgb[1]}, ${fillRgb[2]})`
        let hexCode = rgbToHex(fillRgb[0], fillRgb[1], fillRgb[2]);
        html += `<div class="color-swatch" style="background-color: ${fill}; width: 64px; height: 64px">
            <div class="color-swatch-label">${hexCode}</div>
        </div>`
    }
    html += "</td>";
    html += "</div>"; // end inner-swatches
    html += "</tr>"
    return html;
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function displayClusters() {
    let clusterCountryIdxs = getClusterCountryIdxs();
    while (Object.entries(clusterCountryIdxs).length == 0) {
        await sleep(10);
        clusterCountryIdxs = getClusterCountryIdxs();
    }
    let html = '';
    for (const [cluster, countryIdxs] of Object.entries(clusterCountryIdxs)) {
        html += '<div class="cluster">';
        html += `<h1>Cluster ${cluster} (count=${countryIdxs.length})</h1>`;
        // flags images
        html += '<div class="flag-images">'
        for (let i=0; i<countryIdxs.length; ++i) {
            let countryIdx = countryIdxs[i];
            html += getFlagImgHtml(cluster, countryIdx);
        }
        html += "</div>"; // end flag-images
        // color swatches
        html += '<div class="color-swatches">'
        for (let i=0; i<countryIdxs.length; ++i) {
            let countryIdx = countryIdxs[i];
            let country = getCountryByIdx(countryIdx);
            let countryFeatures = getFeaturesByCountryName(country.name);
            html += '<div class="color-swatch-container">'
            html += "<div>" + country.name + "</div>";
            html += "<div>";
            html += getFlagImgHtml(cluster, countryIdx);
            html += "</div>";

            html += '<div class="hcentered">';
            html += "<table>";
            html += getColorSwatchesHtml("fills_rgb", countryFeatures)
            html += getColorSwatchesHtml("fills_rgb_low", countryFeatures)
            html += "</table>";
            html += "</div>";

            html += "</div>"; // end color-swatch-container
        }
        html += "</div>"; // end color-swatches
        html += "</div>"; // end cluster
    }

    $('#clustersContainer').html(html);
}

$(document).ajaxStop(function() {
    // This function runs when the number of active AJAX requests becomes zero.
    console.log("All jQuery AJAX requests have completed.");
    displayClusters();
    // You might unbind the event if it only needs to run once
    //$(this).off('ajaxStop');
});

</script>
<meta name="viewport" content="width=720, initial-scale=0.5, user-scalable=no">
</head>
<body>
<header>
    <a href="index.html">Flags Game</a>
</header>
<main>
<div id="clustersContainer">
    Test
</div>
</main>
<footer>
</footer>
</body>
</html>
