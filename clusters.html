<html>
<head>
<link rel="stylesheet" type="text/css" href="flags.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="flags.js"></script>
<script>


function getFlagImgHtml(cluster, clusterCountry, clusterCountryIdx) {
    html = '';
    const pattern = / /gi;
    let countryNameWikiEscaped = clusterCountry.name.replace(pattern, "_");
    html += `<a href="https://en.wikipedia.org/wiki/${countryNameWikiEscaped}">`;
    html += `<img class="flag-image" id="${cluster}-${clusterCountryIdx}" src="${clusterCountry.filename}" border="0" />`;
    html += `</a>`;
    return html;
}

function componentToHex(c) {
  var hex = c.toString(16);
  return hex.length == 1 ? "0" + hex : hex;
}

function rgbToHex(r, g, b) {
  return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
}

function getColorSwatchesHtml(key, clusterCountryFeatures) {
    html = '';
    html += `<div class="inner-swatches">`; //innner-swatches
    html += `<div>${key}</div>`
    let fillsRgb = clusterCountryFeatures[key];
    for (let j=0; j<fillsRgb.length; ++j) {
        let fillRgb = fillsRgb[j];
        let fill = `rgb(${fillRgb[0]}, ${fillRgb[1]}, ${fillRgb[2]})`
        let hexCode = rgbToHex(fillRgb[0], fillRgb[1], fillRgb[2]);
        html += `<div class="color-swatch" style="background-color: ${fill}; width: 64px; height: 64px">
            <div class="color-swatch-label">${hexCode}</div>
        </div>`
    }
    html += "</div>"; // end inner-swatches
    html += "<br>";
    return html;
}

function displayClusters() {
    let clusterCountries = {};
    let clusters = getClusters();
    for (const [svgFilename, assignedCluster] of Object.entries(clusters)) {
        console.log(`cluster ${svgFilename}=${assignedCluster}`);
        let country = getCountryFromSvgFilename(svgFilename);
        //skip svgs not in countries list e.g. retired flag
        if (country != null) {
            if (assignedCluster in clusterCountries) {
                clusterCountries[assignedCluster].push(country);
            } else {
                clusterCountries[assignedCluster] = [country];
            }
        }
    }

    let html = '';
    for (const [cluster, countryClusterCountries] of Object.entries(clusterCountries)) {
        html += '<div class="cluster">';
        html += `<h1>Cluster ${cluster} (count=${countryClusterCountries.length})</h1>`;
        // flags images
        html += '<div class="flag-images">'
        for (let i=0; i<countryClusterCountries.length; ++i) {
            let clusterCountry = countryClusterCountries[i];
            html += getFlagImgHtml(cluster, clusterCountry, i);
        }
        html += "</div>"; // end flag-images
        // color swatches
        html += '<div class="color-swatches">'
        for (let i=0; i<countryClusterCountries.length; ++i) {
            html += '<div class="color-swatch-container">'
            let clusterCountry = countryClusterCountries[i];
            let clusterCountryFeatures = getFeaturesByCountryName(clusterCountry.name);
            html += "<div>" + clusterCountry.name + "</div>";
            html += "<div>";
            html += getFlagImgHtml(cluster, clusterCountry, i);
            html += "</div>";
            html += getColorSwatchesHtml("fills_rgb", clusterCountryFeatures)
            html += getColorSwatchesHtml("fills_rgb_low", clusterCountryFeatures)
            html += "</div>"; // end color-swatch-container
        }
        html += "</div>"; // end color-swatches
        html += "</div>"; // end cluster
    }

    $('#clustersContainer').html(html);
}

$(document).ajaxStop(function() {
    // This function runs when the number of active AJAX requests becomes zero.
    console.log("All jQuery AJAX requests have completed.");
    displayClusters();
    // You might unbind the event if it only needs to run once
    $(this).off('ajaxStop');
});

</script>
</head>
<body>
<div id="clustersContainer">
    Test
</div>
</body>
</html>